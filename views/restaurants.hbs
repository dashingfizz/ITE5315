{{> header}}

<div class="container mt-4">
    
    <!-- Stadium Selection -->
    <div class="row mb-4">
        <div class="col-md-4">
            <label class="form-label fw-bold">Select Stadium</label>
            <select id="stadium" class="form-select" onchange="loadBusinesses()">
                <option value="">-- Choose Stadium --</option>
                {{#each stadiums}}
                    <option value="{{this._id}}">{{this.team}} - {{this.stadium}}</option>
                {{/each}}
            </select>
        </div>

        <!-- City Filter -->
        <div class="col-md-4">
            <label class="form-label fw-bold">Filter by City</label>
            <select id="city" class="form-select" onchange="loadBusinesses()">
                <option value="">All Cities</option>
                {{#each cities}}
                    <option value="{{this}}">{{this}}</option>
                {{/each}}
            </select>
        </div>

        <!-- Category Filter -->
        <div class="col-md-4">
            <label class="form-label fw-bold">Filter by Category</label>
            <select id="category" class="form-select" onchange="loadBusinesses()">
                <option value="">All Categories</option>
                {{#each categories}}
                    <option value="{{this}}">{{this}}</option>
                {{/each}}
            </select>
        </div>
    </div>

    <!-- SORT -->
    <div class="row mb-4">
        <div class="col-md-4">
            <label class="form-label fw-bold">Sort By</label>
            <select id="sort" class="form-select" onchange="loadBusinesses()">
                <option value="">Default</option>
                <option value="rating">Rating</option>
                <option value="review_count">Review Count</option>
            </select>
        </div>
    </div>

    <div id="loadingSpinner" class="text-center my-4" style="display:none;">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading businesses...</p>
    </div>

    <!-- RESULTS WILL BE PLACED HERE -->
    <div id="businessResults" class="row"></div>

    <!-- PAGINATION -->
    <div class="d-flex justify-content-center mt-4">
        <nav style="overflow-x:auto;">
            <ul id="pagination" class="pagination flex-nowrap"></ul>
        </nav>
    </div>
</div>

{{> footer}}

<script>
    async function loadBusinesses(page = 1) {
        const stadiumId = document.getElementById("stadium").value;
        const category = document.getElementById("category").value;
        const city = document.getElementById("city").value;
        const sort = document.getElementById("sort").value;

        if (!stadiumId) return;

        const params = new URLSearchParams({
            page,
            category,
            city,
            sort
        });

        // SHOW SPINNER
        document.getElementById("loadingSpinner").style.display = "block";

        // CLEAR old results
        document.getElementById("businessResults").innerHTML = "";

        try {
            const res = await fetch(`/api/stadiums/${stadiumId}/restaurants?` + params);
            const data = await res.json();

            renderBusinesses(data.businesses);
            updatePagination(data.page, data.totalPages);
        } catch (err) {
            document.getElementById("businessResults").innerHTML =
                `<p class="text-danger text-center">Failed to load businesses.</p>`;
        }

        // HIDE SPINNER
        document.getElementById("loadingSpinner").style.display = "none";
    }

    function renderBusinesses(businesses) {
        const container = document.getElementById("businessResults");
        container.innerHTML = businesses.map(b => `
            <div class="col-md-4 mb-4">
                <div class="card">
                    <img src="${b.image_url}" class="card-img-top" alt="Business Image">
                    <div class="card-body">
                        <h5 class="card-title">${b.name}</h5>
                        <p class="card-text">${b.location.address1}, ${b.location.city}</p>
                        <p class="mb-0">Rating: ${b.rating}</p>
                    </div>
                </div>
            </div>
        `).join("");
    }

    function updatePagination(page, totalPages) {
        const ul = document.getElementById("pagination");
        ul.innerHTML = "";

        for (let i = 1; i <= totalPages; i++) {
            ul.innerHTML += `
                <li class="page-item ${i === page ? 'active' : ''}">
                    <button class="page-link" onclick="loadBusinesses(${i})">${i}</button>
                </li>
            `;
        }
    }
</script>
